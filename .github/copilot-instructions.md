## Copilot Instructions
- Project: Art Finance Hub (Flutter web/iOS/Android finance tracker) with local-first storage and optional Firestore sync; Node.js Cloud Functions power passwordless email-link auth and emails.
- Architecture: UI/screens → providers/services → data layer; keep UI free of storage/auth logic. `StorageService` mediates local SharedPreferences plus `SyncService` (current `FirestoreSyncService`) for cloud; modes `localOnly` vs `cloudSync` and manual sync helpers must preserve offline-first semantics. Multi-project data/migration handled in storage/services; soft-delete projects/users.
- Preferences & currency: `PreferencesService` + `CurrencyConversionService` store language (en/es/ca) and currency (EUR/USD). Currency changes update symbols via Frankfurter API rate but do **not** convert historical amounts. CSV export includes `Currency` column for each transaction.
- Auth: Email-link/passwordless flow lives in `lib/services/auth_service.dart` and `lib/screens/auth/*`; backend token verification in `functions/registration_service.js` plus email templates. Firestore rules isolate `users/{uid}/…`; registration/login flows documented in `docs/AUTH_SETUP.md` and `docs/REGISTRATION_FLOW.md`.
- Sync: Local-first per `docs/BACKEND_SYNC.md`—save locally first, then sync when authenticated/online. Use `StorageMode` toggles, `forceSyncToCloud/fromCloud`, and single-record helpers instead of rewriting whole collections.
- Observability/consent: Grafana Faro is web-only and gated by user consent; never log amounts/PII. Keep privacy toggles intact (`PRIVACY.md`).
- Cloud Functions: Located in `functions/`; Jest scripts `npm test`, `npm run test:unit`, `npm run test:e2e`, `npm run test:coverage`. E2E hits deployed/local HTTP endpoints; set `FUNCTIONS_BASE_URL` and Firebase creds when running locally.
- Core Flutter workflows: `flutter pub get`; run `flutter run -d chrome` (or device). Tests: unit/widget `flutter test --coverage --exclude-tags=integration`; integration `flutter test --tags=integration`. Prefer widget/unit coverage; keep E2E minimal and critical (auth/sync happy paths).
- Deployment: Web deploy via multi-stage Docker + nginx. Use `./scripts/setup-gcp.sh` to bootstrap GCP, `./scripts/deploy.sh` to build/test/publish to Cloud Run, `./scripts/rollback.sh` to revert revisions. CI `deploy-gcp.yml` deploys main after tests.
- CI/tests: `docs/TESTING_WORKFLOW.md` describes `test-all.yml` running Flutter unit/widget, integration, and functions unit/e2e with a summary job; branch protection expects those checks. Cloud functions tests live in `functions/__tests__/`.
- Conventions (see `claude.md`): strict TDD (write failing test first), target 80%+ coverage, files/classes small, dependency injection over singletons, depend on abstractions (`SyncService`, repo interfaces), no globals. Enforce localization (no hardcoded user-facing strings), strong typing, explicit error handling, and cross-platform/accessibility parity.
- Docs & hygiene: Update README/architecture docs and `claude.md` when behavior changes. Never commit secrets; update `.gitignore`/cleanup scripts if new artifacts appear.
- Reference docs to consult: `claude.md`, `docs/ARCHITECTURE.md`, `docs/BACKEND_SYNC.md`, `docs/MULTI_CURRENCY_SUPPORT.md`, `docs/AUTH_SETUP.md`, `docs/TESTING_WORKFLOW.md`, `docs/IMPLEMENTATION_SUMMARY.md`, `functions/TESTING.md`.